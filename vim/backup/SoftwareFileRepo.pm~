package Repository::SoftwareFileRepo;

use Moo;
with 'Software::Repository';

use WSB;
use WSB::TypeLibrary qw( AbsDir HashRef );
use Software;
use YAML::XS;
use Path::Tiny;

my $wsb = WSB->new();
has 'search_dir' => (
    is      => 'ro',
    isa     => AbsDir,
    default => sub { WSB::instance()->plugin_dir() },
);

has 'config_file' => (
    is      => 'ro',
    isa     => Str,
    default => sub { 'config.yml' },
);

sub find {
    my $self = shift;
    my $name = shift;
    my $config_file = path( $wsb->plugin_dir() . "/${name}/config.yml" );
    my $yaml;

    if ( $config_file->is_file() ) {
        $yaml = YAML::XS::LoadFile( $config_file );
    }

    if ( defined $yaml ) {
        return Software->new( $yaml );
    } else {
        return undef;
    }
}

sub findAll {
    my $self = shift;
    my $iter = path( $wsb->plugin_dir() )->iterator();
    my @list;

    while ( my $dir = $iter->() ) {
        if ( $dir->is_dir() ) {
            my $basename = $self->find( $dir->basename() );

            if ( defined $basename ) {
                push( @list, $basename );
            }
        }
    }

    return \@list;
}

1;
